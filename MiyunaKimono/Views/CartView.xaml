<UserControl x:Class="MiyunaKimono.Views.CartView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:svc="clr-namespace:MiyunaKimono.Services"
             Background="#fafafa">
    <ScrollViewer VerticalScrollBarVisibility="Auto">
        <StackPanel Margin="24">

            <!-- แถบบาร์ขาวบนสุด -->
            <Border Style="{StaticResource TopWhiteBar}">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition/>
                    </Grid.ColumnDefinitions>

                    <!-- Back -->
                    <Button Style="{StaticResource IconButtonNoHover}" Width="140" Height="44"
                            Click="Back_Click">
                        <StackPanel Orientation="Horizontal">
                            <Path Data="M 22,8 L 8,22 L 22,36"
                                  Stroke="#333" StrokeThickness="3"
                                  StrokeStartLineCap="Round" StrokeEndLineCap="Round"
                                  Margin="0,0,8,0"/>
                            <TextBlock Text="Back" FontWeight="SemiBold" FontSize="16" VerticalAlignment="Center"/>
                        </StackPanel>
                    </Button>

                    <StackPanel Grid.Column="1" Orientation="Horizontal" VerticalAlignment="Center" Margin="12,0,0,0">
                        <TextBlock Text="Shopping cart" FontSize="20" FontWeight="SemiBold"/>
                        <TextBlock Text="  "/>
                        <TextBlock Text="{Binding ItemsCountText}" FontSize="16" Foreground="#444"/>
                    </StackPanel>
                </Grid>
            </Border>

            <!-- กล่องใหญ่: ซ้ายรายละเอียด/ขวาสรุป -->
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition/>
                    <ColumnDefinition Width="28"/>
                    <ColumnDefinition Width="520"/>
                </Grid.ColumnDefinitions>

                <!-- ซ้าย -->
                <!-- ซ้าย: รายการสินค้า -->
                <Border Grid.Column="0" Style="{StaticResource CardWhite}" Padding="28">
                    <!-- เปิด SharedSizeScope ที่คอนเทนเนอร์แม่ -->
                    <Grid Grid.IsSharedSizeScope="True">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                        </Grid.RowDefinitions>

                        <TextBlock Text="Product details" FontSize="22" FontWeight="SemiBold"/>

                        <!-- ===== หัวคอลัมน์ (ใช้ SharedSizeGroup เดียวกับแถวรายการ) ===== -->
                        <!-- หัวคอลัมน์ -->
                        <Grid Grid.Row="1" Margin="0,16,0,8">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="140" SharedSizeGroup="colImage"/>
                                <!-- รูป กว้างขึ้นนิด -->
                                <ColumnDefinition Width="*"   SharedSizeGroup="colInfo"/>
                                <!-- รายละเอียด -->
                                <ColumnDefinition Width="40"/>
                                <!-- GAP 1 -->
                                <ColumnDefinition Width="250" SharedSizeGroup="colQty"/>
                                <!-- QTY -->
                                <ColumnDefinition Width="28"/>
                                <!-- GAP 2 -->
                                <ColumnDefinition Width="180" SharedSizeGroup="colPrice"/>
                                <!-- PRICE -->
                                <ColumnDefinition Width="28"/>
                                <!-- GAP 3 -->
                                <ColumnDefinition Width="180" SharedSizeGroup="colTotal"/>
                                <!-- TOTAL -->
                            </Grid.ColumnDefinitions>

                            <TextBlock Grid.Column="0"/>
                            <TextBlock Grid.Column="1"/>

                            <TextBlock Grid.Column="3" Text="QTY" Width="80"   FontWeight="SemiBold" Foreground="#666"/>
                            <TextBlock Grid.Column="5" Text="PRICE" Width="150" FontWeight="SemiBold" Foreground="#666"/>
                            <TextBlock Grid.Column="7" Text="TOTAL" Width="150" FontWeight="SemiBold" Foreground="#666"/>
                        </Grid>


                        <!-- ===== รายการสินค้า (ListBox มีสกรอลล์ของตัวเอง) ===== -->
                        <ListBox Grid.Row="2"
             ItemsSource="{Binding Lines}"
             BorderThickness="0"
             MaxHeight="560"
             ScrollViewer.VerticalScrollBarVisibility="Auto"
             VirtualizingStackPanel.IsVirtualizing="True"
             VirtualizingStackPanel.VirtualizationMode="Recycling"
             SelectionMode="Single">
                            <!-- ตัดสีไฮไลต์เลือก/โฮเวอร์ให้โปร่งใส -->
                            <ListBox.ItemContainerStyle>
                                <Style TargetType="ListBoxItem">
                                    <Setter Property="Padding" Value="0"/>
                                    <Setter Property="Background" Value="Transparent"/>
                                    <Setter Property="BorderThickness" Value="0"/>
                                    <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
                                    <Setter Property="FocusVisualStyle" Value="{x:Null}"/>
                                    <Style.Triggers>
                                        <Trigger Property="IsSelected" Value="True">
                                            <Setter Property="Background" Value="Transparent"/>
                                        </Trigger>
                                        <Trigger Property="IsMouseOver" Value="True">
                                            <Setter Property="Background" Value="Transparent"/>
                                        </Trigger>
                                    </Style.Triggers>
                                </Style>
                            </ListBox.ItemContainerStyle>

                            <ListBox.ItemTemplate>
                                <DataTemplate>
                                    <Border BorderBrush="#EEE" BorderThickness="0,0,0,1"
            Padding="0,18" Margin="0,6,0,6">
                                        <!-- เพิ่มช่องว่างบน/ล่าง -->
                                        <Grid>
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="140" SharedSizeGroup="colImage"/>
                                                <ColumnDefinition Width="*"   SharedSizeGroup="colInfo"/>
                                                <ColumnDefinition Width="40"/>
                                                <!-- GAP 1 -->
                                                <ColumnDefinition Width="160" SharedSizeGroup="colQty"/>
                                                <ColumnDefinition Width="28"/>
                                                <!-- GAP 2 -->
                                                <ColumnDefinition Width="180" SharedSizeGroup="colPrice"/>
                                                <ColumnDefinition Width="28"/>
                                                <!-- GAP 3 -->
                                                <ColumnDefinition Width="180" SharedSizeGroup="colTotal"/>
                                            </Grid.ColumnDefinitions>

                                            <!-- รูป -->
                                            <Border Grid.Column="0" Width="120" Height="90" Background="#EEE" CornerRadius="8" Margin="0,0,8,0">
                                                <Image Source="{Binding Product.Image1Path}" Stretch="UniformToFill"/>
                                            </Border>

                                            <!-- รายละเอียด -->
                                            <StackPanel Grid.Column="1" Margin="14,0,0,0">
                                                <TextBlock Text="{Binding Product.ProductName}" FontWeight="SemiBold"/>
                                                <TextBlock Foreground="#777" Margin="0,3,0,0">
            <Run Text="{Binding Product.Brand, TargetNullValue=—}"/><Run Text="  "/>
            <Run Text="{Binding Product.Category, TargetNullValue=—}"/>
                                                </TextBlock>
                                            </StackPanel>

                                            <!-- QTY (อยู่คอลัมน์ 3 เพราะคอลัมน์ 2 คือ GAP) -->
                                            <Border Grid.Column="3" CornerRadius="12" BorderBrush="#D8D8D8" BorderThickness="1"
                Background="White" HorizontalAlignment="Left" Margin="0,0,0,0">
                                                <Grid>
                                                    <Grid.ColumnDefinitions>
                                                        <ColumnDefinition Width="56"/>
                                                        <ColumnDefinition Width="70"/>
                                                        <ColumnDefinition Width="56"/>
                                                    </Grid.ColumnDefinitions>
                                                    <RepeatButton Grid.Column="0" Style="{StaticResource StepperMinusButton}"
                                                          Content="—" Interval="60" Tag="{Binding}" Click="DecrementLine_Click"/>
                                                    <TextBox Grid.Column="1" Style="{StaticResource StepperCenterBox}" Width="70"
                                                             Text="{Binding Quantity, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                                             Tag="{Binding}"
                                                             PreviewTextInput="Qty_PreviewTextInput"
                                                             LostFocus="Qty_LostFocus"/>
                                                    <RepeatButton Grid.Column="2" Style="{StaticResource StepperPlusButton}"
                                                              Content="+" Interval="60" Tag="{Binding}" Click="IncrementLine_Click"/>
                                                </Grid>
                                            </Border>

                                            <!-- PRICE: ใช้ LinePrice -->
                                            <StackPanel Grid.Column="5" Orientation="Horizontal" HorizontalAlignment="Left">
                                                <TextBlock Text="{Binding LinePrice, StringFormat={}{0:N0}}"/>
                                                <TextBlock Text="  THB"/>
                                            </StackPanel>

                                            <!-- TOTAL: ใช้ LineTotal -->
                                            <StackPanel Grid.Column="7" Orientation="Horizontal" HorizontalAlignment="Left">
                                                <TextBlock Text="{Binding LineTotal, StringFormat={}{0:N0}}" FontWeight="SemiBold"/>
                                                <TextBlock Text="  THB"/>
                                            </StackPanel>
                                        </Grid>
                                    </Border>
                                </DataTemplate>
                            </ListBox.ItemTemplate>

                        </ListBox>
                    </Grid>
                </Border>


                <!-- ขวา -->
                <Border Grid.Column="2" Style="{StaticResource CardWhite}">
                    <StackPanel>
                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                            </Grid.RowDefinitions>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition/>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="50"/>
                            </Grid.ColumnDefinitions>

                            <TextBlock Grid.Row="0" Grid.Column="0" Text="Item"/>
                            <TextBlock Grid.Row="0" Grid.Column="1" Text="{Binding ItemsCount}"/>
                            <TextBlock Grid.Row="0" Grid.Column="2" Text="Item"/>

                            <TextBlock Grid.Row="1" Grid.Column="0" Text="Discount"/>
                            <TextBlock Grid.Row="1" Grid.Column="1" Text="{Binding DiscountTotalText}"/>
                            <TextBlock Grid.Row="1" Grid.Column="2" Text="THB"/>

                            <TextBlock Grid.Row="2" Grid.Column="0" Text="Total Cost" FontWeight="SemiBold"/>
                            <TextBlock Grid.Row="2" Grid.Column="1" Text="{Binding GrandTotalText}" FontWeight="SemiBold"/>
                            <TextBlock Grid.Row="2" Grid.Column="2" Text="THB" FontWeight="SemiBold"/>
                        </Grid>

                        <TextBlock Text="Address" FontSize="16" FontWeight="SemiBold" Margin="0,18,0,6"/>
                        <TextBox x:Name="AddressBox" Height="180" TextWrapping="Wrap" AcceptsReturn="True"
                                 Style="{StaticResource WatermarkTextBox}"
                                 Tag="กรุณากรอกที่อยู่ แขวง ตำบล รหัสไปรษณีย์ของท่าน "/>

                        <Button Content="Checkout" Height="44" Margin="0,16,0,0"
                                Style="{StaticResource PrimaryButton}"
                                Click="Checkout_Click"/>
                    </StackPanel>
                </Border>
            </Grid>
        </StackPanel>
    </ScrollViewer>
</UserControl>
